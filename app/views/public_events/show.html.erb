<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      
      <!-- Event Header -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h1 class="display-4 mb-3">
            <%= @event.name %>
            <% if @event.reference? %>
              <span class="badge bg-secondary fs-6 ms-2">External Event</span>
            <% elsif @event.participating? %>
              <span class="badge bg-info fs-6 ms-2">We're Participating</span>
            <% end %>
          </h1>
          
          <!-- Event Details -->
          <div class="row mb-3">
            <div class="col-md-6">
              <p class="mb-2">
                <i class="bi bi-calendar-event text-primary"></i>
                <strong>Date:</strong> <%= @event.event_date.strftime('%A, %B %d, %Y') %>
              </p>
              <% if @event.start_time.present? %>
                <p class="mb-2">
                  <i class="bi bi-clock text-primary"></i>
                  <strong>Time:</strong> 
                  <%= @event.start_time.strftime('%I:%M %p') %>
                  <% if @event.end_time.present? %>
                    - <%= @event.end_time.strftime('%I:%M %p') %>
                  <% end %>
                </p>
              <% end %>
            </div>
            <div class="col-md-6">
              <% if @event.venue.present? %>
                <p class="mb-2">
                  <i class="bi bi-geo-alt text-primary"></i>
                  <strong>Venue:</strong> <%= @event.venue.name %>
                </p>
                <% if @event.venue.address.present? %>
                  <p class="mb-2 text-muted">
                    <%= @event.venue.address %>
                  </p>
                <% end %>
              <% end %>
            </div>
          </div>

          <!-- Event Description -->
          <% if @event.description.present? %>
            <div class="mt-4">
              <h5>About This Event</h5>
              <p class="text-muted"><%= simple_format(@event.description) %></p>
            </div>
          <% end %>

          <!-- Capacity Info — hosted only -->
          <% if @event.hosted? && @event.max_attendees.present? %>
            <div class="mt-4">
              <div class="progress" style="height: 25px;">
                <% percentage = (@event.attendees_count.to_f / @event.max_attendees * 100).round %>
                <div class="progress-bar" role="progressbar"
                     style="width: <%= percentage %>%"
                     aria-valuenow="<%= @event.attendees_count %>"
                     aria-valuemin="0"
                     aria-valuemax="<%= @event.max_attendees %>">
                  <%= @event.attendees_count %> / <%= @event.max_attendees %> attending
                </div>
              </div>
            </div>
          <% end %>

          <!-- RSVP Deadline — hosted only -->
          <% if @event.hosted? && @event.rsvp_deadline.present? %>
            <div class="alert <%= @event.rsvp_open? ? 'alert-info' : 'alert-warning' %> mt-3">
              <i class="bi bi-clock"></i>
              <% if @event.rsvp_open? %>
                RSVP by <%= @event.rsvp_deadline.strftime('%B %d, %Y at %I:%M %p') %>
              <% else %>
                RSVP deadline has passed
              <% end %>
            </div>
          <% end %>

          <!-- External link — reference/participating -->
          <% if (@event.reference? || @event.participating?) && @event.external_url.present? %>
            <div class="mt-4">
              <%= link_to @event.external_url, target: '_blank', rel: 'noopener',
                          class: 'btn btn-outline-primary btn-lg' do %>
                <i class="bi bi-box-arrow-up-right"></i>
                View Official Event Page &rarr;
              <% end %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- RSVP Form — hosted events only -->
      <% if @event.hosted? %>
        <% if @event.rsvp_open? %>
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
              <% if @existing_rsvp %>
                Update Your RSVP
              <% else %>
                RSVP for This Event
              <% end %>
            </h4>
          </div>
          <div class="card-body">
            <%= form_with model: @event_participant, url: public_event_rsvp_path(@event.slug), method: :post, local: true do |f| %>
              
              <% unless current_user %>
                <!-- Guest Information -->
                <div class="mb-3">
                  <label for="event_participant_guest_name" class="form-label">Your Name *</label>
                  <%= f.text_field :guest_name, class: 'form-control', required: true, placeholder: 'John Doe' %>
                </div>

                <div class="mb-3">
                  <label for="event_participant_guest_email" class="form-label">Email (optional - for updates)</label>
                  <%= f.email_field :guest_email, class: 'form-control', placeholder: 'john@example.com' %>
                  <small class="form-text text-muted">We'll only use this to send you event updates</small>
                </div>

                <div class="mb-3">
                  <label for="event_participant_guest_phone" class="form-label">Phone (optional)</label>
                  <%= f.text_field :guest_phone, class: 'form-control', placeholder: '(555) 123-4567' %>
                </div>
              <% else %>
                <div class="alert alert-info">
                  RSVPing as <strong><%= current_user.full_name %></strong> (<%= current_user.email %>)
                </div>
              <% end %>

              <!-- RSVP Status -->
              <div class="mb-4">
                <label class="form-label fw-bold">Will you attend? *</label>
                <div class="btn-group w-100" role="group">
                  <%= f.radio_button :rsvp_status, 'yes', class: 'btn-check', id: 'rsvp_yes', required: true %>
                  <label class="btn btn-outline-success" for="rsvp_yes">
                    <i class="bi bi-check-circle"></i> Yes, I'll be there!
                  </label>

                  <%= f.radio_button :rsvp_status, 'maybe', class: 'btn-check', id: 'rsvp_maybe' %>
                  <label class="btn btn-outline-warning" for="rsvp_maybe">
                    <i class="bi bi-question-circle"></i> Maybe
                  </label>

                  <%= f.radio_button :rsvp_status, 'no', class: 'btn-check', id: 'rsvp_no' %>
                  <label class="btn btn-outline-danger" for="rsvp_no">
                    <i class="bi bi-x-circle"></i> Can't make it
                  </label>
                </div>
              </div>

              <!-- Custom Questions -->
              <% if @event.custom_questions.present? && @event.custom_questions.any? %>
                <div class="mb-4">
                  <h5>Additional Information</h5>
                  <% @event.custom_questions.each_with_index do |question, index| %>
                    <div class="mb-3">
                      <label class="form-label"><%= question['question'] %></label>
                      <%= text_field_tag "event_participant[rsvp_answers][#{question['id']}]", 
                                        @event_participant.rsvp_answers&.dig(question['id'].to_s),
                                        class: 'form-control' %>
                    </div>
                  <% end %>
                </div>
              <% end %>

              <!-- Notes -->
              <div class="mb-4">
                <label for="event_participant_notes" class="form-label">Additional Notes (optional)</label>
                <%= f.text_area :notes, class: 'form-control', rows: 3, 
                                placeholder: 'Dietary restrictions, accessibility needs, etc.' %>
              </div>

              <!-- Submit Button -->
              <div class="d-grid">
                <%= f.submit @existing_rsvp ? 'Update RSVP' : 'Submit RSVP', 
                            class: 'btn btn-primary btn-lg' %>
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i>
          RSVPs are no longer being accepted for this event.
        </div>
      <% end %>
      <% end %> <%# end hosted? %>

      <!-- Existing RSVP Display -->
      <% if @existing_rsvp && !@event.rsvp_open? %>
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h5>Your RSVP Status</h5>
            <p class="mb-0">
              <strong>Status:</strong> 
              <span class="badge bg-<%= @existing_rsvp.rsvp_status == 'yes' ? 'success' : 'warning' %>">
                <%= @existing_rsvp.rsvp_status_text %>
              </span>
            </p>
          </div>
        </div>
      <% end %>

    </div>
  </div>
</div>
