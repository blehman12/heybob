# evm1 Architecture Decisions — Session Summary
**Date:** February 22, 2026  
**Session scope:** Deploy recovery, taxonomy system, role expansion, export/migration strategy

---

## 1. Deploy Crash Lessons Learned

**Root cause pattern:** Rails migrations run in timestamp order on a fresh Railway build.
Any model callback or seed that references an enum value by *name* or a *column that doesn't exist yet* will crash.

**Fixes applied:**
- `create_initial_admin_user` migration: changed `role: :admin` → `role: 1` (raw integer bypasses enum name lookup)
- `HasExternalId` concern: added `column_names.include?('external_id')` guard so `before_create` silently skips when the column hasn't been added yet

**Standing rule:** Never use enum names in historical migrations. Use the integer. Never add a `before_create`/`before_save` that touches a column without a column-existence guard.

---

## 2. Event Type Classification

Three types implemented as `event_type` integer enum on Event:

| Type | Value | Use Case | RSVP | Venue | External URL |
|------|-------|----------|------|-------|--------------|
| `hosted` | 0 | We run it — full capability | ✓ required | ✓ required | optional |
| `participating` | 1 | We have a presence (booth/sponsor/speaker) | ✗ | optional | ✓ required |
| `reference` | 2 | Awareness only — link out | ✗ | optional | ✓ required |

Admin form: three-button toggle with JavaScript field show/hide.
Public event page: badges, conditional RSVP form, external link button.

---

## 3. Faceted Taxonomy System

**Architecture:** Two models, one level of hierarchy per facet.

```
Category          Categorization (polymorphic join)
--------          --------------------------------
name              category_id
slug              categorizable_id
facet (enum)      categorizable_type (Event / User / Vendor)
parent_id
position
active
```

**Five facets seeded (32 categories total):**
- **Domain** — PLM Tools (Windchill, Creo, Arena, Teamcenter, ENOVIA), ERP/MES (SAP, Oracle), General PLM
- **Format** — Conference, User Group, Training, Meetup, Trade Show, Convention, Webinar
- **Geography** — Pacific Northwest, North America, Europe, Virtual, International
- **Fandom** — Anime, Gaming, Comic, Pop Culture, Tabletop
- **Audience** — Engineers, Managers, IT, Executives, Other

**Governance maturity model (agreed):**
1. Admin-managed vocabulary, admin assigns to events ← *current phase*
2. Role-based delegation (event_admins tag their own events) ← *current phase*
3. Users self-select interests from controlled vocabulary ← *backlog*
4. AI-assisted inference confirms/suggests interests based on behavior ← *backlog*

**Pending work:**
- Category checkboxes on admin event form
- Public events index with tag filtering
- Clean filterable URL scheme (`/events?tag=windchill`) for Columbia River PLM integration

---

## 4. User Role Expansion

Expanded from binary admin/attendee to five roles. **Integer values are fixed — do not reorder.**

| Role | Value | Capability |
|------|-------|------------|
| `attendee` | 0 | Default |
| `super_admin` | 1 | Full access (was 'admin' — value preserved, no data migration needed) |
| `event_admin` | 2 | Manage events, assign categories |
| `venue_admin` | 3 | Manage venues |
| `vendor_admin` | 4 | Manage vendors |

`admin?` helper returns true for *any* elevated role.
`Admin::BaseController` has granular `ensure_*` methods for each capability.

---

## 5. Export / Migration Strategy

**Philosophy:** Export is the stable contract. Transform/load is bespoke to the migration target.
Analogy: Export = STEP neutral format. Transformer = translator written for a specific destination, discarded after use.

**What was built:**

### `external_id` UUID (HasExternalId concern)
- Added to: Event, Vendor, Category, User
- Auto-populated on `before_create`
- Guarded against column-not-existing during early migrations
- Existing records backfilled via migration `20260222000006_backfill_external_ids`
- All cross-references in exports use `external_id` not database IDs

### Export endpoint
- `GET /admin/export` — super_admin only
- Returns single JSON document
- Structure: `{ schema_version, exported_at, app, counts, categories, users, events, vendors }`
- Categories reference parents by `external_id`
- Events include participants (by `external_id`), vendor_events, category tags
- Users include interest category list

### Version field
- `schema_version: "1.0"` — increment when export structure changes
- `exported_at` ISO8601 timestamp on every export

**Dashboard link added:** Super-admin tools section at bottom of Quick Actions.

**When you need to migrate:** Hit export → save JSON → write a targeted transformer for the destination → run it → discard the transformer. The export contract doesn't change.

---

## 6. Backlog Items Added This Session

- [ ] Category checkboxes on admin event form
- [ ] Public events index with tag filtering + clean URL scheme
- [ ] Columbia River PLM filtered event feed (`/events?tag=windchill`)
- [ ] Seed categories in production: `railway run bundle exec rails runner db/seeds/categories.rb`
- [ ] Event visibility/status enum (draft / unlisted / public, active / archived / stale / cancelled)
- [ ] User interest self-selection from controlled vocabulary (Phase 3 taxonomy)

---

## Key Files

| Purpose | Path |
|---------|------|
| Export controller | `app/controllers/admin/export_controller.rb` |
| External ID concern | `app/models/concerns/has_external_id.rb` |
| Category model | `app/models/category.rb` |
| Categorization join | `app/models/categorization.rb` |
| Category admin UI | `app/controllers/admin/categories_controller.rb` |
| Role authorization | `app/controllers/admin/base_controller.rb` |
| Category seeds | `db/seeds/categories.rb` |
