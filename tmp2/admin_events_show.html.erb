<div class="container-fluid">
  <div class="row mb-3">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to "Admin", admin_root_path %></li>
          <li class="breadcrumb-item"><%= link_to "Events", admin_events_path %></li>
          <li class="breadcrumb-item active" aria-current="page"><%= @event.name %></li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-8">
      <h1><%= @event.name %></h1>
    </div>
    <div class="col-md-4 text-end">
      <%= link_to "Edit Event", edit_admin_event_path(@event), class: "btn btn-primary" %>
      <%= link_to "Delete Event", admin_event_path(@event), method: :delete, 
          data: { confirm: "Are you sure you want to delete this event?" }, 
          class: "btn btn-danger" %>
    </div>
  </div>

  <div class="row">
    <!-- Main Event Details -->
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header">
          <h5><i class="bi bi-calendar-event"></i> Event Details</h5>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <p><strong>Date:</strong><br>
                <%= @event.event_date&.strftime("%A, %B %d, %Y") || 'Not set' %>
              </p>
            </div>
            <div class="col-md-6">
              <p><strong>Time:</strong><br>
                <% if @event.start_time %>
                  <%= @event.start_time.strftime("%I:%M %p") %>
                  <% if @event.end_time %>
                    - <%= @event.end_time.strftime("%I:%M %p") %>
                  <% end %>
                <% else %>
                  Not set
                <% end %>
              </p>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <p><strong>Venue:</strong><br>
                <% if @event.venue %>
                  <%= @event.venue.name %><br>
                  <small class="text-muted"><%= @event.venue.address %></small>
                <% else %>
                  <span class="text-muted">No venue assigned</span>
                <% end %>
              </p>
            </div>
            <div class="col-md-6">
              <p><strong>Created by:</strong><br>
                <%= @event.creator&.full_name || 'Unknown' %>
                <% if @event.created_at %>
                  <br><small class="text-muted"><%= @event.created_at.strftime("%b %d, %Y") %></small>
                <% end %>
              </p>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <p><strong>Capacity:</strong><br>
                <%= @event.max_attendees || 'Unlimited' %> attendees
                <% if @event.max_attendees && @event.respond_to?(:spots_remaining) %>
                  <br><small class="text-muted"><%= @event.spots_remaining %> spots remaining</small>
                <% end %>
              </p>
            </div>
            <div class="col-md-6">
              <p><strong>RSVP Deadline:</strong><br>
                <% if @event.rsvp_deadline %>
                  <%= @event.rsvp_deadline.strftime("%B %d, %Y at %I:%M %p") %>
                  <% if @event.rsvp_deadline < Time.current %>
                    <br><span class="badge bg-warning">Closed</span>
                  <% else %>
                    <br><span class="badge bg-success">Open</span>
                  <% end %>
                <% else %>
                  <span class="text-muted">No deadline</span>
                <% end %>
              </p>
            </div>
          </div>

          <% if @event.description.present? %>
            <hr>
            <p><strong>Description:</strong></p>
            <%= simple_format(@event.description) %>
          <% end %>

          <% if @event.custom_questions.present? %>
            <hr>
            <p><strong>Custom Questions:</strong></p>
            <ul>
              <% @event.custom_questions.each do |question| %>
                <li><%= question %></li>
              <% end %>
            </ul>
          <% end %>
        </div>
      </div>

      <!-- Participants Section -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5><i class="bi bi-people"></i> Participants (<%= @event.event_participants.count %>)</h5>
          <div>
            <%= link_to "Add Participant", participants_admin_event_path(@event), class: "btn btn-sm btn-success" %>
            <%= link_to "Bulk Invite", "#", class: "btn btn-sm btn-primary", 
                data: { bs_toggle: "modal", bs_target: "#bulkInviteModal" } %>
            <%= link_to "Export CSV", export_participants_admin_event_path(@event, format: :csv), 
                class: "btn btn-sm btn-secondary" %>
          </div>
        </div>
        <div class="card-body">
          <% if @event.event_participants.any? %>
            <!-- Organizers -->
            <% organizers = @event.event_participants.where(role: :organizer).includes(:user) %>
            <% if organizers.any? %>
              <h6 class="mt-3"><span class="badge bg-info text-dark">Organizers</span> (<%= organizers.count %>)</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Company</th>
                      <th>RSVP</th>
                      <th>Checked In</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% organizers.each do |participant| %>
                      <tr>
                        <td><%= participant.user&.full_name || 'Unknown' %></td>
                        <td><%= participant.user&.email || 'N/A' %></td>
                        <td><%= participant.user&.company || 'N/A' %></td>
                        <td>
                          <% 
                            status_class = case participant.rsvp_status.to_s
                                         when 'yes', '1' then 'success'
                                         when 'maybe', '3' then 'warning'
                                         when 'no', '2' then 'danger'
                                         else 'secondary'
                                         end
                          %>
                          <span class="badge bg-<%= status_class %>">
                            <%= participant.rsvp_status.to_s.humanize %>
                          </span>
                        </td>
                        <td>
                          <% if participant.checked_in? %>
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <small class="text-muted"><%= participant.checked_in_at&.strftime("%I:%M %p") %></small>
                          <% else %>
                            <span class="text-muted">No</span>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% end %>

            <!-- Vendors -->
            <% vendors = @event.event_participants.where(role: :vendor).includes(:user) %>
            <% if vendors.any? %>
              <h6 class="mt-3"><span class="badge bg-warning text-dark">Vendors</span> (<%= vendors.count %>)</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Company</th>
                      <th>RSVP</th>
                      <th>Checked In</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% vendors.each do |participant| %>
                      <tr>
                        <td><%= participant.user&.full_name || 'Unknown' %></td>
                        <td><%= participant.user&.email || 'N/A' %></td>
                        <td><%= participant.user&.company || 'N/A' %></td>
                        <td>
                          <% 
                            status_class = case participant.rsvp_status.to_s
                                         when 'yes', '1' then 'success'
                                         when 'maybe', '3' then 'warning'
                                         when 'no', '2' then 'danger'
                                         else 'secondary'
                                         end
                          %>
                          <span class="badge bg-<%= status_class %>">
                            <%= participant.rsvp_status.to_s.humanize %>
                          </span>
                        </td>
                        <td>
                          <% if participant.checked_in? %>
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <small class="text-muted"><%= participant.checked_in_at&.strftime("%I:%M %p") %></small>
                          <% else %>
                            <span class="text-muted">No</span>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% end %>

            <!-- Attendees -->
            <% attendees = @event.event_participants.where(role: :attendee).includes(:user) %>
            <% if attendees.any? %>
              <h6 class="mt-3"><span class="badge bg-primary">Attendees</span> (<%= attendees.count %>)</h6>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Company</th>
                      <th>RSVP</th>
                      <th>Checked In</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% attendees.each do |participant| %>
                      <tr>
                        <td><%= participant.user&.full_name || 'Unknown' %></td>
                        <td><%= participant.user&.email || 'N/A' %></td>
                        <td><%= participant.user&.company || 'N/A' %></td>
                        <td>
                          <% 
                            status_class = case participant.rsvp_status.to_s
                                         when 'yes', '1' then 'success'
                                         when 'maybe', '3' then 'warning'
                                         when 'no', '2' then 'danger'
                                         else 'secondary'
                                         end
                          %>
                          <span class="badge bg-<%= status_class %>">
                            <%= participant.rsvp_status.to_s.humanize %>
                          </span>
                        </td>
                        <td>
                          <% if participant.checked_in? %>
                            <i class="bi bi-check-circle-fill text-success"></i>
                            <small class="text-muted"><%= participant.checked_in_at&.strftime("%I:%M %p") %></small>
                          <% else %>
                            <span class="text-muted">No</span>
                          <% end %>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% end %>
          <% else %>
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> No participants yet. 
              <%= link_to "Add participants", participants_admin_event_path(@event) %> to get started.
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Sidebar - Stats & Actions -->
    <div class="col-md-4">
      <!-- RSVP Statistics -->
      <div class="card mb-3">
        <div class="card-header">
          <h5><i class="bi bi-bar-chart"></i> RSVP Statistics</h5>
        </div>
        <div class="card-body">
          <% 
            total = @event.event_participants.count
            yes_count = @event.event_participants.where(rsvp_status: :yes).count
            no_count = @event.event_participants.where(rsvp_status: :no).count
            maybe_count = @event.event_participants.where(rsvp_status: :maybe).count
            pending_count = @event.event_participants.where(rsvp_status: :pending).count
          %>
          
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>Total Invited:</span>
              <strong><%= total %></strong>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span class="text-success">Yes:</span>
              <strong><%= yes_count %> (<%= total > 0 ? (yes_count.to_f / total * 100).round : 0 %>%)</strong>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span class="text-warning">Maybe:</span>
              <strong><%= maybe_count %> (<%= total > 0 ? (maybe_count.to_f / total * 100).round : 0 %>%)</strong>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span class="text-danger">No:</span>
              <strong><%= no_count %> (<%= total > 0 ? (no_count.to_f / total * 100).round : 0 %>%)</strong>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span class="text-secondary">Pending:</span>
              <strong><%= pending_count %> (<%= total > 0 ? (pending_count.to_f / total * 100).round : 0 %>%)</strong>
            </div>
          </div>

          <% if total > 0 %>
            <div class="progress" style="height: 25px;">
              <% if yes_count > 0 %>
                <div class="progress-bar bg-success" role="progressbar" 
                     style="width: <%= (yes_count.to_f / total * 100).round %>%" 
                     aria-valuenow="<%= yes_count %>" aria-valuemin="0" aria-valuemax="<%= total %>">
                  <%= yes_count %>
                </div>
              <% end %>
              <% if maybe_count > 0 %>
                <div class="progress-bar bg-warning" role="progressbar" 
                     style="width: <%= (maybe_count.to_f / total * 100).round %>%" 
                     aria-valuenow="<%= maybe_count %>" aria-valuemin="0" aria-valuemax="<%= total %>">
                  <%= maybe_count %>
                </div>
              <% end %>
              <% if no_count > 0 %>
                <div class="progress-bar bg-danger" role="progressbar" 
                     style="width: <%= (no_count.to_f / total * 100).round %>%" 
                     aria-valuenow="<%= no_count %>" aria-valuemin="0" aria-valuemax="<%= total %>">
                  <%= no_count %>
                </div>
              <% end %>
              <% if pending_count > 0 %>
                <div class="progress-bar bg-secondary" role="progressbar" 
                     style="width: <%= (pending_count.to_f / total * 100).round %>%" 
                     aria-valuenow="<%= pending_count %>" aria-valuemin="0" aria-valuemax="<%= total %>">
                  <%= pending_count %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Check-in Statistics -->
      <div class="card mb-3">
        <div class="card-header">
          <h5><i class="bi bi-check-circle"></i> Check-in Status</h5>
        </div>
        <div class="card-body">
          <% 
            checked_in_count = @event.event_participants.where.not(checked_in_at: nil).count
            expected_count = yes_count
          %>
          
          <div class="d-flex justify-content-between mb-2">
            <span>Checked In:</span>
            <strong><%= checked_in_count %> / <%= expected_count %></strong>
          </div>
          
          <% if expected_count > 0 %>
            <div class="progress">
              <div class="progress-bar bg-success" role="progressbar" 
                   style="width: <%= (checked_in_count.to_f / expected_count * 100).round %>%" 
                   aria-valuenow="<%= checked_in_count %>" aria-valuemin="0" aria-valuemax="<%= expected_count %>">
                <%= (checked_in_count.to_f / expected_count * 100).round %>%
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <h5><i class="bi bi-lightning"></i> Quick Actions</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <%= link_to admin_event_path(@event), class: "btn btn-outline-primary" do %>
              <i class="bi bi-eye"></i> View Public Page
            <% end %>
            
            <%= link_to participants_admin_event_path(@event), class: "btn btn-outline-success" do %>
              <i class="bi bi-person-plus"></i> Manage Participants
            <% end %>
            
            <%= link_to export_participants_admin_event_path(@event, format: :csv), class: "btn btn-outline-secondary" do %>
              <i class="bi bi-download"></i> Export Participants
            <% end %>
            
            <%= link_to edit_admin_event_path(@event), class: "btn btn-outline-warning" do %>
              <i class="bi bi-pencil"></i> Edit Event
            <% end %>
            
            <%= link_to admin_event_path(@event), method: :delete, 
                data: { confirm: "Are you sure? This will delete all participants and RSVPs!" }, 
                class: "btn btn-outline-danger" do %>
              <i class="bi bi-trash"></i> Delete Event
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Invite Modal -->
<div class="modal fade" id="bulkInviteModal" tabindex="-1" aria-labelledby="bulkInviteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkInviteModalLabel">Bulk Invite Users</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%= form_with url: bulk_invite_participants_admin_event_path(@event), method: :post do |form| %>
        <div class="modal-body">
          <p>Select users to invite to this event:</p>
          <% available_users = User.where.not(id: @event.event_participants.select(:user_id)) %>
          <% if available_users.any? %>
            <% available_users.each do |user| %>
              <div class="form-check">
                <%= check_box_tag 'user_ids[]', user.id, false, class: 'form-check-input', id: "user_#{user.id}" %>
                <%= label_tag "user_#{user.id}", user.full_name, class: 'form-check-label' %>
                <small class="text-muted d-block"><%= user.email %> - <%= user.company %></small>
              </div>
            <% end %>
          <% else %>
            <div class="alert alert-info">All users have already been invited to this event.</div>
          <% end %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= form.submit "Send Invitations", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
